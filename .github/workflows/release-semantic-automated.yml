name: Release
on:
  workflow_call:
    inputs:
      BRANCHES:
        description: The release branches. Provide it in JSON string format as ["main", "next"].
        default: ''
        required: false
        type: string
      MAIN_FILENAME:
        description: If there is a main file with the WordPress header, provide its name. Default index.php for WordPress plugin and style.css for WordPress theme.
        required: false
        default: ''
        type: string
      FILES_TO_COMMIT:
        description: File names where the version number needs to be updated and thus they need to be committed. Provide it in JSON string format as ["CHANGELOG.md", "package-lock.json", "package.json", "composer.json"].
        required: false
        type: string
      NODE_VERSION:
        description: Node version with which the release will be executed.
        default: 18
        required: false
        type: string

jobs:
  release:
    name: Release
    timeout-minutes: 5
    runs-on: ubuntu-latest
    env:
      MAIN_FILENAME: ${{ inputs.MAIN_FILENAME }}
      FILES_TO_COMMIT: ${{ inputs.FILES_TO_COMMIT }}
      BRANCHES: ${{ inputs.BRANCHES }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ inputs.NODE_VERSION }}

      - name: Install dependencies
        run: |
          npm i -g @semantic-release/changelog \
            @semantic-release/git \
            @semantic-release/npm \
            @google/semantic-release-replace-plugin \
            semantic-release \
            ejs

      - name: Checkout
        uses: actions/checkout@v3

      - name: Remove Husky hooks
        run: rm -f .husky/pre-commit

      - name: Check presence of release.config.js
        run: |
          HAS_CONFIG=false
          if [ -f "release.config.js" ]; then 
            echo "Configuration file release.config.js found" 
            HAS_CONFIG=true
          fi

      - name: Get package type
        run: |
          PACKAGE_TYPE=$(cat composer.json | jq '.type')

      - name: Prepare main filename for a WordPress plugin
        if: ${{ (env.PACKAGE_TYPE == 'wordpress-plugin' || env.PACKAGE_TYPE == 'wordpress-muplugin') && env.HAS_CONFIG == false }}
        run: |
          echo "MAIN_FILENAME=${MAIN_FILENAME:-"index.php"}" >> $GITHUB_ENV

      - name: Prepare main filename for a WordPress theme
        if: ${{ env.PACKAGE_TYPE == 'wordpress-theme' && env.HAS_CONFIG == false }}
        run: |
          echo "MAIN_FILENAME=${MAIN_FILENAME:-"style.css"}" >> $GITHUB_ENV

      - name: Prepare list of files to commit
        if: ${{ env.HAS_CONFIG == false }}
        run: |
          if [ -z "$FILES_TO_COMMIT" ]; then
            if [ -z "$MAIN_FILENAME" ]; then
              FILES_TO_COMMIT='["CHANGELOG.md", "package-lock.json", "package.json", "composer.json"]'
            else
              FILES_TO_COMMIT='["CHANGELOG.md", "package-lock.json", "package.json", "composer.json", "'$MAIN_FILENAME'"]'
            fi
          fi
          echo "FILES_TO_COMMIT=$(echo $FILES_TO_COMMIT | sed 's/"/\\"/g')" >> $GITHUB_ENV

      - name: Prepare list of branches
        if: ${{ env.HAS_CONFIG == false }}
        run: |
          BRANCHES=${BRANCHES:-'["main", "next", {"name": "beta", "prerelease": true}, {"name": "alpha", "prerelease": true}]'}
          echo "BRANCHES=$(echo $BRANCHES | sed 's/"/\\"/g')" >> $GITHUB_ENV

      - name: Configure semantic release if config file not provided
        if: ${{ env.HAS_CONFIG == false }}
        run: |
          wget https://raw.githubusercontent.com/inpsyde/reusable-workflows/automatic-release/templates/release-semantic-automated/release.config.ejs
          ejs release.config.ejs -o release.config.js branches="${{ env.BRANCHES }}" mainFilename=${{ env.MAIN_FILENAME }} filesToCommit="${{ env.FILES_TO_COMMIT }}"
          rm release.config.ejs

      - name: Check the presence of the configuration file
        run: |
          if [ ! -f "release.config.js" ]; then 
            echo "Configuration file release.config.js does not exist, aborting!" 
            exit 1
          fi

      
