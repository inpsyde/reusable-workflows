name: Release
on:
  workflow_call:
    inputs:
      BRANCHES:
        description: The release branches. Provide it in JSON format.
        default: '["main", "next", {"name": "beta", "prerelease": true}, {"name": "alpha", "prerelease": true} ]'
        required: false
        type: string
      PACKAGE_TYPE:
        description: Choices are "wordpress-plugin", "wordpress-theme", "library", "custom". Needed to understand what release procedure to run or to run a completely custom procedure that lives inside the repository
        required: true
        type: string
      MAIN_FILENAME:
        description: Main file name where the WordPress header is present
        required: true
        type: string
      FILES:
        description: File names where the version number needs to be updated. Provide it in JSON format.
        required: true
        type: string

jobs:
  release:
    name: Release
    timeout-minutes: 5
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Install dependencies
        run: |
          npm i -g @semantic-release/changelog \
            @semantic-release/commit-analyzer \
            @semantic-release/exec \
            @semantic-release/git \
            @semantic-release/github \
            @semantic-release/npm \
            @semantic-release/release-notes-generator \
            semantic-release \
            ejs
      - name: FIRST DEBUG POINT
        run: |
          ls -al ${{ github.path }}
          ls -al ${{ github.workspace }}
          echo ${GITHUB_ACTION_PATH}
          echo 'last line'
      - name: Create semantic release bot configuration file
        if: ${{ inputs.PACKAGE_TYPE }} != "custom"
        run: ejs ../../templates/release-semantic-bot/release.config.ejs -o release.config.js files=${{ inputs.FILES }}
      - name: Configure semantic release bot for a wordpress plugin
        if: ${{ inputs.PACKAGE_TYPE }} == "wordpress-plugin"
        run: ejs ../../templates/release-semantic-bot/release-wordpress-plugin.ejs -o release.sh filename=${{ inputs.MAIN_FILENAME }}
      - name: Configure semantic release bot for a wordpress theme
        if: ${{ inputs.PACKAGE_TYPE }} == "wordpress-theme"
        run: ejs ../../templates/release-semantic-bot/release-wordpress-theme.ejs -o release.sh filename=${{ inputs.MAIN_FILENAME }}
      - name: Configure semantic release bot for a library
        if: ${{ inputs.PACKAGE_TYPE }} == "library"
        run: ejs ../../templates/release-semantic-bot/release-library.ejs -o release.sh filename=${{ inputs.MAIN_FILENAME }}
      - name: Configure semantic release bot for a custom package
        if: ${{ inputs.PACKAGE_TYPE }} == "custom"
        run: echo "Using repository release configurations"
      - name: DEBUG
        run: |
          echo ${GITHUB_ACTION_PATH}
          cat release.sh
          cat release.config.js
      - name: Checkout
        uses: actions/checkout@v3


      - name: Remove Husky hooks
        run: rm -f .husky/pre-commit

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release --branches ${{inputs.BRANCHES}} --tag-format "${version}"
